> 어제 철야근무를 하면서 /var 디렉터리가 54G 까지 올라왔고, 앱 데이터 디렉터리도 40G 가까이 올라가면서 디스크 풀로 인한 개발용 인스턴스가 멈추는 증상이 발생했었다. 급한대로 인프라팀에 연락해 조치를 취했는데, 잘 처리해주셔서 잘 마무리 되었다. <br>
>
> 이 일이 있은 뒤로 로그 보존 기한도 어느 정도 짧게 잡아야 겠다는 생각을 했다. 인프라팀 분이 없었으면 이틀은 머리싸매고 있지 않았을까 싶다. 초당 데이터가 많을 때는 워낙에 많기도 하고, 쓸데 없는 데이터가 워낙 많이 들어오기도 해서 시스템 로그도 같이 많이 쌓이지 않았나 싶다.<br>
>
> 개발용 인스턴스이기에 디스크 크기도 작게 잡았었는데, 오히려 이게 어쩌면 득이 된것 같다. 상용에 올렸을때 어떤 장애가 날수 있는지 미리 파악할 수 있는 기회였다는 생각이 들었다.<br>

<br>

개발 인스턴스의 java 설치 디렉터리를 확인해보니 /usr/bin/java 였다. 이것만으로는 /var/log 디렉터리와의 연관성을 찾기는 힘들었다. 하지만, 비교를 위해서 게발용 인스턴스 내의 /home/ec2-user/env 에 별도의 JDK 인스턴스를 다운 받아서 설치한 후에 애플리케이션 구동시 이 JDK 인스턴스를 사용하는 경우와 비교해봐야 할 것 같다.<br>

<br>

## 참고자료

- [https://jadehan.tistory.com/](https://jadehan.tistory.com/11)

<br>

## var 디렉터리

`/var` 디렉터리는 spool directory 나 파일, 로그 데이터, 임시파일 등의 가변 데이터 파일들을 저장하는 디렉터리다. /var 디렉터리는 /usr 디렉터리가 read-only 로 마운트한다. 시스템 운영을 하는 동안 /usr 디렉터리에 작성한 모든 것들이 /var 디렉터리에 있어야 한다.<br>

- /var 아래의 공유 가능한 디렉터리
  - /var/log, /var/run, /var/cache/man, /var/cache/fonts, /var/spool/news 

<br>

위의 참고자료에서는 /var 디렉터리를 /usr 디렉터리 아래에 이동시킬 때 주의점을 이야기하고 잇다. /var 디렉터리를 /usr 디렉터리에 옮기면 root 계층의 사이즈를 줄이고, 부하를 줄이는 데에 도움을 준다. 하지만, 네이밍 충돌 및 계층 분리의 어려움으로 인해 /var 디렉터리와 /usr 디렉터리가 절대 link 로 연결되면 안된다고 이야기하고 있다.<br>

<br>

그 대안으로 /usr 이 /var 과 link 를 걸때는 /var -> /usr/var 로 연결한다. <br>

일단, 개발자 입장에서는 위의 내용까지 모두 알 필요는 없고 아래 내용만 알고 있으면 될 듯 하다.<br>

- /var 디렉터리는 spool directory, 파일, 로그데이터, 임시파일 등 가변 데이터 파일을 저장하는 디렉터리다.
- 시스템 운영을 하는 동안 /usr 디렉터리에 작성한 모든 것들이 /var 디렉터리에 있어야 한다.

<br>

내가 생각하는 어제 장애의 원인은 /usr 아래에 시스템 전역으로 JDK를 설치해서 쓰고 있는데, 앱 로그 말고도 JVM에서 로그를 만들어내고 있어서 이게 /var 에도 같이 쌓인게 아닌가 싶은 생각이 들었다. 이 장애를 어느정도 피해갈 수 있는 방법을 생각해봤는데, 커스텀한 JDK를 따로 다운 받아서 앱 디렉터리에서 실행시키면 되지 않을까 하는 추측이 생겼다.<br>

<br>

## var 디렉터리의 하위 디렉터리들

|       |                                                   |
| ----- | ------------------------------------------------- |
| cache | 애플리케이션의 캐시데이터가 위치                  |
| lib   | 가변 정보 데이터                                  |
| local | /usr/local 아래의 프로그램들의 가변 데이터가 위치 |
| lock  | 잠금 파일들이 있는 디렉터리                       |
| log   | 다양한 로그파일들이 있다.                         |
| opt   | /opt 계층 관련 가변 데이터들이 위치한다.          |
| run   | 프로세스 운영에 관련된 데이터들이 위치한다        |
| spool | 애플리케이션 spool 데이터가 위치                  |
| tmp   | 재부팅 시 임시 보존되는 파일들이 위치             |

<br>

## /var/cache

애플리케이션 캐시 데이터 디렉터리<br>

애플리케이션으로부터 캐시된 데이터가 저장되어야 할 때 사용된다. /var/spool 과는 다르게 캐시 파일들은 데이터 손실 없이 삭제될수 있다.<br>

/var/cache 계층에 존재하는 파일들은 시스템 관리자나, 애플리케이션의 특수한 동작으로 만료될 수 있다.<br>

<br>

## /var/lib

애플리케이션 또는 시스템에 관련된 상태 정보를 수행한다.<br>

`상태 정보란?`<br>

프로그램이 실행되는 동안 수정하고 특정 호스트의 호출과 관련된 데이터. 상태정보는 일반적으로 재부팅 후에도 유효해야 한다. 다만 출력이 로깅되거나 데이터가 스풀되어서는 안된다.<br>

<br>

애플리케이션(또는 내부적으로 연결된 애플리케이션 그룹)은 /var/lib 계층을 서브디렉터리로 사용해야 한다. (이건 처음 알았다. 아마도 jdk 내부적으로는 이런 설정 내용들이 있지 않을까 싶다)<br>

<br>

## /var/local

/usr/local 에 있는 모든 소프트웨어 가변 정보가 포함된다. 소프트웨어 설치사 가끔 /usr/local 에 설치하는 경우가 있는데 이런 경우에 대한 경우 인것 같다. 요약하자면, /usr/local 에 설치하는프로그램들에 대한 정보들은 /var/local 에 해당 프로그램의 정보들이 포함되는 것 같다.<br>

<br>

## /var/lock

lock files 를 저장하는 디렉터리다. 디바이스 또는 애플리케이션 들에 의해 공유된다. <br>

자세한 내용은 조금 더 확인해봐야 할 것 같다.<br>

>  참고) lock files 는 과거에는 /var/spool/locks, /var/spool/uucp 디렉터리에 저장되었었다. lock 파일들은 보통 이름 앞에 LCK. 을 붙여서 사용되는 것이 일반적인 네이밍 컨벤션이다. (ex. /dev/ttys0 의 lock : `LCK.ttyS0` )

<br>

## /var/opt

/opt 에 대한 가변 데이터를 저장하는 디렉터리<br>

<br>

## /var/run 

런타임 가변 데이터가 저장되는 곳이다. 예를 들면 crond 의 pid 파일은 /var/run/crond.pid 이다. 

<br>

## /var/spool

애플리케이션 spool 데이터. spool 에는 나중에 처리되기 위해 대기중인 데이터를 포함된다. /var/spool 에 존재하는 데이터들은 시스템 사용자, 관리자, 프로그램이 처리할 작업들인 경우가 있다. 작업이 처리되기 시작하면 삭제된다.<br>

<br>

## /var/tmp

시스템이 재부팅 되는 동안 보존되어야 하는 임시파일들을 저장하는 디렉터리다.그리고 시스템이 재부팅이 완료되면 해당 파일, 디렉터리들은 동시에 삭제되어야 한다.<br>

<br>